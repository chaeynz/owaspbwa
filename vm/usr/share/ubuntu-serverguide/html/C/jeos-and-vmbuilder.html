<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head xmlns="http://www.w3.org/1999/xhtml">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title xmlns="">JeOS and vmbuilder</title>
    <link rel="stylesheet" href="../../libs/ubuntu-book.css" type="text/css" />
    <link rel="home" href="index.html" title="Ubuntu Server Guide" />
    <link rel="up" href="virtualization.html" title="Chapter 19. Virtualization" />
    <link rel="prev" href="libvirt.html" title="libvirt" />
    <link rel="next" href="uec.html" title="UEC" />
    <link rel="copyright" href="legal.html" title="Credits and License" />
  </head>
  <body>
    <div id="round">
      <img id="topcap" alt="" src="https://help.ubuntu.com/htdocs/ubuntunew/img/cap-top.png" />
      <div id="layout" class="container clear-block">
        <script xmlns="" src="https://ssl.google-analytics.com/urchin.js" type="text/javascript"></script>
        <script xmlns="" type="text/javascript">
_uacct = "UA-1018242-8";
urchinTracker();
</script>
        <div id="header">
          <div id="logo-floater">
            <h1>
              <a href="https://help.ubuntu.com" title="Ubuntu Documentation">
                <img alt="Ubuntu" id="logo" src="https://help.ubuntu.com/htdocs/ubuntunew/img/logo.png" />
              </a>
            </h1>
          </div>
          <noscript>
            <form action="http://www.google.com/cse" id="cse-search-box">
              <div>
                <input type="hidden" name="cx" value="004599128559784038176:vj_p0xo-nng" />
                <input type="hidden" name="ie" value="UTF-8" />
                <input type="text" name="q" size="27" />
                <input type="submit" name="sa" value="Search" />
              </div>
            </form>
          </noscript>
          <script>
 document.write('<form action="https://help.ubuntu.com/search.html" id="cse-search-box">');
 document.write('  <div>');
 document.write('    <input type="hidden" name="cof" value="FORID:9" />');
 document.write('    <input type="hidden" name="cx" value="004599128559784038176:vj_p0xo-nng" />');
 document.write('    <input type="hidden" name="ie" value="UTF-8" />');
 document.write('    <input type="text" name="q" size="27" />');
 document.write('    <input type="submit" name="sa" value="Search" />');
 document.write('  </div>');
 document.write('</form>');
</script>
          <div id="sitename">
            <a href="https://help.ubuntu.com/">
              <img alt="Official Documentation" src="https://help.ubuntu.com/htdocs/ubuntunew/img/help-about.png" />
              <span>Official Documentation</span>
            </a>
          </div>
        </div>
        <div id="page">
          <div id="content">
            <div class="breadcrumbs"><a href="https://help.ubuntu.com/">Ubuntu Documentation</a> &gt; <a href="https://help.ubuntu.com/10.04">Ubuntu 10.04</a> &gt; <span class="breadcrumb-link"><a href="index.html">Ubuntu Server Guide</a></span> &gt; <span class="breadcrumb-link"><a href="virtualization.html">Virtualization</a></span> &gt; <span class="breadcrumb-node">JeOS and vmbuilder</span></div>
            <div xmlns="http://www.w3.org/1999/xhtml" class="sect1" title="JeOS and vmbuilder">
              <div class="titlepage">
                <div>
                  <div>
                    <h2 class="title" style="clear: both"><a id="jeos-and-vmbuilder"></a>JeOS and vmbuilder</h2>
                  </div>
                </div>
              </div>
              <div class="sect2" title="Introduction">
                <div class="titlepage">
                  <div>
                    <div>
                      <h3 class="title"><a id="jeos-introduction"></a>Introduction</h3>
                    </div>
                  </div>
                </div>
                <div class="sect3" title="What is JeOS">
                  <div class="titlepage">
                    <div>
                      <div>
                        <h4 class="title"><a id="what-is-jeos"></a>What is JeOS</h4>
                      </div>
                    </div>
                  </div>
                  <p>
  Ubuntu <span class="emphasis"><em>JeOS</em></span> (pronounced "Juice") is an efficient variant of the Ubuntu Server operating system, 
  configured specifically for virtual appliances.  No longer available as a CD-ROM ISO for download, but only as an option either:
  </p>
                  <div class="itemizedlist">
                    <ul class="itemizedlist" type="disc">
                      <li class="listitem">
                        <p>
      While installing from the Server Edition ISO (pressing <span class="emphasis"><em>F4</em></span> on the first screen will allow you to pick 
      "Minimal installation", which is the package selection equivalent to JeOS).
      </p>
                      </li>
                      <li class="listitem">
                        <p>
      Or to be built using Ubuntu's vmbuilder, which is described here. 
      </p>
                      </li>
                    </ul>
                  </div>
                  <p>
  JeOS is a specialized installation of Ubuntu Server Edition with a tuned kernel that only contains the base elements needed 
  to run within a virtualized environment.
  </p>
                  <p>
  Ubuntu JeOS has been tuned to take advantage of key performance technologies in the latest virtualization products from VMware. 
  This combination of reduced size and optimized performance ensures that Ubuntu JeOS Edition delivers a highly efficient use of 
  server resources in large virtual deployments.
  </p>
                  <p>
  Without unnecessary drivers, and only the minimal required packages, ISVs can configure their supporting OS exactly as they require. 
  They have the peace of mind that updates, whether for security or enhancement reasons, will be limited to the bare minimum of what 
  is required in their specific environment. In turn, users deploying virtual appliances built on top of JeOS will have to go through 
  fewer updates and therefore less maintenance than they would have had to with a standard full installation of a server.
  </p>
                </div>
                <div class="sect3" title="What is vmbuilder">
                  <div class="titlepage">
                    <div>
                      <div>
                        <h4 class="title"><a id="what-is-vmbuilder"></a>What is vmbuilder</h4>
                      </div>
                    </div>
                  </div>
                  <p>
      With vmbuilder, there is no need to download a JeOS ISO anymore. vmbuilder will fetch the various package and build a virtual machine 
      tailored for your needs in about a minute. vmbuilder is a script that automates the process of creating a ready to use Linux based
      VM. The currently supported hypervisors are KVM and Xen.
      </p>
                  <p>
      You can pass command line options to add extra packages, remove packages, choose which version of Ubuntu, which mirror etc. On recent 
      hardware with plenty of RAM, tmpdir in <code class="filename">/dev/shm</code> or using a tmpfs, and a local mirror, you can bootstrap a VM in 
      less than a minute.
      </p>
                  <p>
      First introduced as a shell script in Ubuntu 8.04 LTS, <span class="application"><strong>ubuntu-vm-builder</strong></span> started with little emphasis as 
      a hack to help developers test their new code in a virtual machine without having to restart from scratch each time. As a few Ubuntu 
      administrators started to notice this script, a few of them went on improving it and adapting it for so many use case that 
      Soren Hansen (the author of the script and Ubuntu virtualization specialist, not the golf player) decided to rewrite it from scratch 
      for Intrepid as a python script with a few new design goals:
      </p>
                  <div class="itemizedlist">
                    <ul class="itemizedlist" type="disc">
                      <li class="listitem">
                        <p>
          Develop it so that it can be reused by other distributions.
          </p>
                      </li>
                      <li class="listitem">
                        <p>
          Use a plugin mechanisms for all virtualization interactions so that others can easily add logic for other virtualization environments.
          </p>
                      </li>
                      <li class="listitem">
                        <p>
          Provide an easy to maintain web interface as an option to the command line interface.
          </p>
                      </li>
                    </ul>
                  </div>
                  <p>
      But the general principles and commands remain the same. 
      </p>
                </div>
              </div>
              <div class="sect2" title="Initial Setup">
                <div class="titlepage">
                  <div>
                    <div>
                      <h3 class="title"><a id="jeos-initial-setup"></a>Initial Setup</h3>
                    </div>
                  </div>
                </div>
                <p>
    It is assumed that you have installed and configured <span class="application"><strong>libvirt</strong></span> and <span class="application"><strong>KVM</strong></span> locally
    on the machine you are using. For details on how to perform this, please refer to:
    </p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" type="disc">
                    <li class="listitem">
                      <p>
        <a class="xref" href="libvirt.html" title="libvirt">the section called “libvirt”</a>
        </p>
                    </li>
                    <li class="listitem">
                      <p>
        The <a class="ulink" href="https://help.ubuntu.com/community/KVM" target="_top">KVM</a> Wiki page.
        </p>
                    </li>
                  </ul>
                </div>
                <p>
    We also assume that you know how to use a text based text editor such as nano or vi. If you have not used any of them before, 
    you can get an overview of the various text editors available by reading the  
    <a class="ulink" href="https://help.ubuntu.com/community/PowerUsersTextEditors" target="_top">PowerUsersTextEditors</a> page. This tutorial has been 
    done on KVM, but the general principle should remain on other virtualization technologies. 
    </p>
                <div class="sect3" title="Install vmbuilder">
                  <div class="titlepage">
                    <div>
                      <div>
                        <h4 class="title"><a id="install-vmbuilder"></a>Install vmbuilder</h4>
                      </div>
                    </div>
                  </div>
                  <p>
        The name of the package that we need to install is <span class="application"><strong>python-vm-builder</strong></span>.  In a terminal prompt enter: 
        </p>
                  <pre class="screen">
<span class="command"><strong>sudo apt-get install python-vm-builder</strong></span>
</pre>
                  <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;">
                    <table border="0" summary="Note">
                      <tr>
                        <td rowspan="2" align="center" valign="top" width="25">
                          <img alt="[Note]" src="../../libs/admon/note.png" />
                        </td>
                        <th align="left"></th>
                      </tr>
                      <tr>
                        <td align="left" valign="top">
                          <p>
          If you are running Hardy, you can still perform most of this using the older version of the package named 
          <span class="application"><strong>ubuntu-vm-builder</strong></span>, there are only a few changes to the syntax of the tool. 
          </p>
                        </td>
                      </tr>
                    </table>
                  </div>
                </div>
              </div>
              <div class="sect2" title="Defining Your Virtual Machine">
                <div class="titlepage">
                  <div>
                    <div>
                      <h3 class="title"><a id="defining-vm"></a>Defining Your Virtual Machine</h3>
                    </div>
                  </div>
                </div>
                <p>
      Defining a virtual machine with Ubuntu's vmbuilder is quite simple, but here are a few thing to consider:
      </p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" type="disc">
                    <li class="listitem">
                      <p>
          If you plan on shipping a virtual appliance, do not assume that the end-user will know how to extend disk size to fit their need,
          so either plan for a large virtual disk to allow for your appliance to grow, or explain fairly well in your documentation how
          to allocate more space. It might actually be a good idea to store data on some separate external storage.
	  </p>
                    </li>
                    <li class="listitem">
                      <p>
          Given that RAM is much easier to allocate in a VM, RAM size should be set to whatever you think is a safe minimum for your appliance.
	  </p>
                    </li>
                  </ul>
                </div>
                <p>
      The <span class="application"><strong>vmbuilder</strong></span> command has 2 main parameters: the <span class="emphasis"><em>virtualization technology (hypervisor)</em></span>
      and the targeted <span class="emphasis"><em>distribution</em></span>. Optional parameters are quite numerous and can be found using the following command:
      </p>
                <pre class="screen">
<span class="command"><strong>vmbuilder --help</strong></span>
</pre>
                <div class="sect3" title="Base Parameters">
                  <div class="titlepage">
                    <div>
                      <div>
                        <h4 class="title"><a id="vm-base-parameters"></a>Base Parameters</h4>
                      </div>
                    </div>
                  </div>
                  <p>
      As this example is based on <span class="application"><strong>KVM</strong></span> and Ubuntu 10.04 LTS (Lucid Lynx), and we are likely to rebuild 
      the same virtual machine multiple time, we'll invoke vmbuilder with the following first parameters: 
      </p>
                  <pre class="screen">
<span class="command"><strong>sudo vmbuilder kvm ubuntu --suite lucid --flavour virtual --arch i386  -o --libvirt qemu:///system</strong></span>
</pre>
                  <p>
      The <span class="emphasis"><em>--suite</em></span> defines the Ubuntu release, the <span class="emphasis"><em>--flavour</em></span> specifies that we want to use 
      the virtual kernel (that's the one used to build a JeOS image), the <span class="emphasis"><em>--arch</em></span> tells that we want to use a 
      32 bit machine, the <span class="emphasis"><em>-o</em></span> tells vmbuilder to overwrite the previous version of the VM and the 
      <span class="emphasis"><em>--libvirt</em></span> tells to inform the local virtualization environment to add the resulting VM to the list of available
      machines. 
      </p>
                  <p>
      Notes:
      </p>
                  <div class="itemizedlist">
                    <ul class="itemizedlist" type="disc">
                      <li class="listitem">
                        <p>
          Because of the nature of operations performed by vmbuilder, it needs to have root privilege, hence the use of sudo.
          </p>
                      </li>
                      <li class="listitem">
                        <p>
          If your virtual machine needs to use more than 3Gb of ram, you should build a 64 bit machine (--arch amd64).
          </p>
                      </li>
                      <li class="listitem">
                        <p>
          Until Ubuntu 8.10, the virtual kernel was only built for 32 bit architecture, so if you want to define an amd64 machine 
          on Hardy, you should use <span class="emphasis"><em>--flavour</em></span> server instead. 
          </p>
                      </li>
                    </ul>
                  </div>
                </div>
                <div class="sect3" title="JeOS Installation Parameters">
                  <div class="titlepage">
                    <div>
                      <div>
                        <h4 class="title"><a id="jeos-installation-parameters"></a>JeOS Installation Parameters</h4>
                      </div>
                    </div>
                  </div>
                  <div class="sect4" title="JeOS Networking">
                    <div class="titlepage">
                      <div>
                        <div>
                          <h5 class="title"><a id="jeos-networking"></a>JeOS Networking</h5>
                        </div>
                      </div>
                    </div>
                    <div class="sect5" title="Assigning a fixed IP address">
                      <div class="titlepage">
                        <div>
                          <div>
                            <h6 class="title"><a id="jeos-fixed-ip"></a>Assigning a fixed IP address</h6>
                          </div>
                        </div>
                      </div>
                      <p>
        As a virtual appliance that may be deployed on various very different networks, it is very difficult to know what 
        the actual network will look like. In order to simplify configuration, it is a good idea to take an approach similar 
        to what network hardware vendors usually do, namely assigning an initial fixed IP address to the appliance in a 
        private class network that you will provide in your documentation. An address in the range 192.168.0.0/255 is usually a good choice.
        </p>
                      <p>
        To do this we'll use the following parameters:
        </p>
                      <div class="itemizedlist">
                        <ul class="itemizedlist" type="disc">
                          <li class="listitem">
                            <p>
            <span class="emphasis"><em>--ip ADDRESS</em></span>: IP address in dotted form (defaults to dhcp if not specified)
            </p>
                          </li>
                          <li class="listitem">
                            <p>
            <span class="emphasis"><em>--mask VALUE</em></span>: IP mask in dotted form (default: 255.255.255.0)
            </p>
                          </li>
                          <li class="listitem">
                            <p>
            <span class="emphasis"><em>--net VALUE</em></span>: IP net address (default: X.X.X.0)
            </p>
                          </li>
                          <li class="listitem">
                            <p>
            <span class="emphasis"><em>--bcast VALUE</em></span>: IP broadcast (default: X.X.X.255)
            </p>
                          </li>
                          <li class="listitem">
                            <p>
            <span class="emphasis"><em>--gw ADDRESS</em></span>: Gateway address (default: X.X.X.1)
            </p>
                          </li>
                          <li class="listitem">
                            <p>
            <span class="emphasis"><em>--dns ADDRESS</em></span>: Name server address (default: X.X.X.1)
            </p>
                          </li>
                        </ul>
                      </div>
                      <p>
        We assume for now that default values are good enough, so the resulting invocation becomes: 
        </p>
                      <pre class="screen">
<span class="command"><strong>sudo vmbuilder kvm ubuntu --suite lucid --flavour virtual --arch i386 -o --libvirt qemu:///system --ip 192.168.0.100</strong></span>
</pre>
                    </div>
                    <div class="sect5" title="Modifying the libvirt Template to use Bridging">
                      <div class="titlepage">
                        <div>
                          <div>
                            <h6 class="title"><a id="jeos-bridging"></a>Modifying the libvirt Template to use Bridging</h6>
                          </div>
                        </div>
                      </div>
                      <p>
          Because our appliance will be likely to need to be accessed by remote hosts, we need to configure libvirt so that the appliance uses bridge
          networking. To do this we use vmbuilder template mechanism to modify the default one. 
          </p>
                      <p>
          In our working directory we create the template hierarchy and copy the default template: 
          </p>
                      <pre class="screen">
<span class="command"><strong>mkdir -p VMBuilder/plugins/libvirt/templates</strong></span>
<span class="command"><strong>cp /etc/vmbuilder/libvirt/* VMBuilder/plugins/libvirt/templates/</strong></span>
</pre>
                      <p>
          We can then edit <code class="filename">VMBuilder/plugins/libvirt/templates/libvirtxml.tmpl</code> to change:
          </p>
                      <pre class="programlisting">
          &lt;interface type='network'&gt;
            &lt;source network='default'/&gt;
          &lt;/interface&gt;
</pre>
                      <p>
          To:
          </p>
                      <pre class="programlisting">
          &lt;interface type='bridge'&gt;
            &lt;source bridge='br0'/&gt;
          &lt;/interface&gt;
</pre>
                    </div>
                  </div>
                  <div class="sect4" title="Partitioning">
                    <div class="titlepage">
                      <div>
                        <div>
                          <h5 class="title"><a id="jeos-partitioning"></a>Partitioning</h5>
                        </div>
                      </div>
                    </div>
                    <p>
        Partitioning of the virtual appliance will have to take into consideration what you are planning to do with is. Because 
        most appliances want to have a separate storage for data, having a separate <code class="filename">/var</code> would make sense.
        </p>
                    <p>
        In order to do this vmbuilder provides us with <span class="emphasis"><em>--part</em></span>: 
        </p>
                    <pre class="programlisting">
--part PATH
  Allows you to specify a partition table in a partition file, located at PATH. Each line of the partition file should specify
  (root first):
      mountpoint size
  where  size  is  in megabytes. You can have up to 4 virtual disks, a new disk starts on a
  line with ’---’.  ie :
      root 1000
      /opt 1000
      swap 256
      ---
      /var 2000
      /log 1500
</pre>
                    <p>
        In our case we will define a text file name <code class="filename">vmbuilder.partition</code> which will contain the following: 
        </p>
                    <pre class="programlisting">
root 8000
swap 4000
---
/var 20000
</pre>
                    <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;">
                      <table border="0" summary="Note">
                        <tr>
                          <td rowspan="2" align="center" valign="top" width="25">
                            <img alt="[Note]" src="../../libs/admon/note.png" />
                          </td>
                          <th align="left"></th>
                        </tr>
                        <tr>
                          <td align="left" valign="top">
                            <p>
          Note that as we are using virtual disk images, the actual sizes that we put here are maximum sizes for these volumes. 
          </p>
                          </td>
                        </tr>
                      </table>
                    </div>
                    <p>
        Our command line now looks like: 
        </p>
                    <pre class="screen">
<span class="command"><strong>sudo vmbuilder kvm ubuntu --suite lucid --flavour virtual --arch i386 \ 
         -o --libvirt qemu:///system --ip 192.168.0.100 --part vmbuilder.partition</strong></span>
</pre>
                    <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;">
                      <table border="0" summary="Note">
                        <tr>
                          <td rowspan="2" align="center" valign="top" width="25">
                            <img alt="[Note]" src="../../libs/admon/note.png" />
                          </td>
                          <th align="left"></th>
                        </tr>
                        <tr>
                          <td align="left" valign="top">
                            <p>
          Using a "\" in a command will allow long command strings to wrap to the next line.
          </p>
                          </td>
                        </tr>
                      </table>
                    </div>
                  </div>
                  <div class="sect4" title="User and Password">
                    <div class="titlepage">
                      <div>
                        <div>
                          <h5 class="title"><a id="jeos-user-password"></a>User and Password</h5>
                        </div>
                      </div>
                    </div>
                    <p>
        Again setting up a virtual appliance, you will need to provide a default user and password that is generic so 
        that you can include it in your documentation. We will see later on in this tutorial how we will provide some 
        security by defining a script that will be run the first time a user actually logs in the appliance, that will, 
        among other things, ask him to change his password. In this example I will use <span class="emphasis"><em>'user'</em></span> as my 
        user name, and <span class="emphasis"><em>'default'</em></span> as the password.
        </p>
                    <p>
        To do this we use the following optional parameters: 
        </p>
                    <div class="itemizedlist">
                      <ul class="itemizedlist" type="disc">
                        <li class="listitem">
                          <p>
            <span class="emphasis"><em>--user USERNAME:</em></span> Sets the name of the user to be added. Default: ubuntu.
            </p>
                        </li>
                        <li class="listitem">
                          <p>
            <span class="emphasis"><em>--name FULLNAME:</em></span> Sets the full name of the user to be added. Default: Ubuntu.
            </p>
                        </li>
                        <li class="listitem">
                          <p>
            <span class="emphasis"><em>--pass PASSWORD:</em></span>   Sets the password for the user. Default: ubuntu.
            </p>
                        </li>
                      </ul>
                    </div>
                    <p>
        Our resulting command line becomes:
        </p>
                    <pre class="screen">
<span class="command"><strong>sudo vmbuilder kvm ubuntu --suite lucid --flavour virtual --arch i386 \
         -o --libvirt qemu:///system --ip 192.168.0.100 --part vmbuilder.partition \ 
         --user user --name user --pass default</strong></span>
</pre>
                  </div>
                </div>
                <div class="sect3" title="Installing Required Packages">
                  <div class="titlepage">
                    <div>
                      <div>
                        <h4 class="title"><a id="jeos-required-packages"></a>Installing Required Packages</h4>
                      </div>
                    </div>
                  </div>
                  <p>
      In this example we will be installing a package <span class="application"><strong>(Limesurvey)</strong></span> that accesses a 
      <span class="application"><strong>MySQL</strong></span> database and has a web interface. We will therefore require our OS to 
      provide us with:
      </p>
                  <div class="itemizedlist">
                    <ul class="itemizedlist" type="disc">
                      <li class="listitem">
                        <p>Apache</p>
                      </li>
                      <li class="listitem">
                        <p>PHP</p>
                      </li>
                      <li class="listitem">
                        <p>MySQL</p>
                      </li>
                      <li class="listitem">
                        <p>OpenSSH Server</p>
                      </li>
                      <li class="listitem">
                        <p>Limesurvey (as an example application that we have packaged)</p>
                      </li>
                    </ul>
                  </div>
                  <p>
      This is done using vmbuilder by specifying the --addpkg option multiple times:
      </p>
                  <pre class="programlisting">
--addpkg PKG
  Install PKG into the guest (can be specfied multiple times)
</pre>
                  <p>
      However, due to the way vmbuilder operates, packages that have to ask questions to the user during the post install phase are not supported and
      should instead be installed while interactivity can occur. This is the case of Limesurvey, which we will have to install later, once the user logs
      in.
      </p>
                  <p>
      Other packages that ask simple debconf question, such as <span class="application"><strong>mysql-server</strong></span> asking to set a password, the package can be
      installed immediately, but we will have to reconfigure it the first time the user logs in.
      </p>
                  <p>
     If some packages that we need to install are not in main, we need to enable the additional repositories using --comp and --ppa: 
     </p>
                  <pre class="programlisting">
--components COMP1,COMP2,...,COMPN
           A comma separated list of distro components to include (e.g. main,universe). This defaults
           to "main"
--ppa=PPA  Add ppa belonging to PPA to the vm's sources.list.
</pre>
                  <p>
      Limesurvey not being part of the archive at the moment, we'll specify it's PPA (personal package archive) address so that it is added to the VM 
      <code class="filename">/etc/apt/source.list</code>, so we add the following options to the command line:
      </p>
                  <pre class="screen">
<span class="command"><strong>--addpkg apache2 --addpkg apache2-mpm-prefork --addpkg apache2-utils --addpkg apache2.2-common \
         --addpkg dbconfig-common --addpkg libapache2-mod-php5 --addpkg mysql-client --addpkg php5-cli \
         --addpkg php5-gd --addpkg php5-ldap --addpkg php5-mysql --addpkg wwwconfig-common \
         --addpkg mysql-server --ppa nijaba</strong></span>
</pre>
                  <div class="sect4" title="OpenSSH">
                    <div class="titlepage">
                      <div>
                        <div>
                          <h5 class="title"><a id="jeos-openssh"></a>OpenSSH</h5>
                        </div>
                      </div>
                    </div>
                    <p>
          Another convenient tool that we want to have on our appliance is OpenSSH, as it will allow our admins to access 
          the appliance remotely. However, pushing in the wild an appliance with a pre-installed OpenSSH server is a big security
          risk as all these server will share the same secret key, making it very easy for hackers to target our appliance with all
          the tools they need to crack it open in a breeze. As for the user password, we will instead rely on a script that will
          install OpenSSH the first time a user logs in so that the key generated will be different for each appliance. For this
          we'll use a <span class="emphasis"><em>--firstboot</em></span> script, as it does not need any user interaction.
          </p>
                  </div>
                </div>
                <div class="sect3" title="Speed Considerations">
                  <div class="titlepage">
                    <div>
                      <div>
                        <h4 class="title"><a id="jeos-speed-consideration"></a>Speed Considerations</h4>
                      </div>
                    </div>
                  </div>
                  <div class="sect4" title="Package Caching">
                    <div class="titlepage">
                      <div>
                        <div>
                          <h5 class="title"><a id="jeos-package-caching"></a>Package Caching</h5>
                        </div>
                      </div>
                    </div>
                    <p>       
          When vmbuilder creates builds your system, it has to go fetch each one of the packages that composes it over the network 
          to one of the official repositories, which, depending on your internet connection speed and the load of the mirror, can 
          have a big impact on the actual build time. In order to reduce this, it is recommended to either have a local repository 
          (which can be created using <span class="application"><strong>apt-mirror</strong></span>) or using a caching proxy such as 
          <span class="application"><strong>apt-proxy</strong></span>. The later option being much simpler to implement and requiring less disk space, it
          is the one we will pick in this tutorial. To install it, simply type:
          </p>
                    <pre class="screen">
<span class="command"><strong>sudo apt-get install apt-proxy</strong></span>
</pre>
                    <p>
          Once this is complete, your (empty) proxy is ready for use on http://mirroraddress:9999 and will find ubuntu repository 
          under /ubuntu. For vmbuilder to use it, we'll have to use the <span class="emphasis"><em>--mirror</em></span> option:
          </p>
                    <pre class="programlisting">
--mirror=URL  Use Ubuntu mirror at URL instead of the default, which
              is http://archive.ubuntu.com/ubuntu for official
              arches and http://ports.ubuntu.com/ubuntu-ports
              otherwise
</pre>
                    <p>
          So we add to the command line: 
          </p>
                    <pre class="screen">
<span class="command"><strong>--mirror http://mirroraddress:9999/ubuntu</strong></span>
</pre>
                    <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;">
                      <table border="0" summary="Note">
                        <tr>
                          <td rowspan="2" align="center" valign="top" width="25">
                            <img alt="[Note]" src="../../libs/admon/note.png" />
                          </td>
                          <th align="left"></th>
                        </tr>
                        <tr>
                          <td align="left" valign="top">
                            <p>
            The mirror address specified here will also be used in the <code class="filename">/etc/apt/sources.list</code> of the newly created 
            guest, so it is useful to specify here an address that can be resolved by the guest or to plan on reseting this address 
            later on, such as in a <span class="emphasis"><em>--firstboot</em></span> script.
            </p>
                          </td>
                        </tr>
                      </table>
                    </div>
                  </div>
                  <div class="sect4" title="Install a Local Mirror">
                    <div class="titlepage">
                      <div>
                        <div>
                          <h5 class="title"><a id="jeos-local-mirror"></a>Install a Local Mirror</h5>
                        </div>
                      </div>
                    </div>
                    <p>
            If we are in a larger environment, it may make sense to setup a local mirror of the Ubuntu repositories. 
            The package apt-mirror provides you with a script that will handle the mirroring for you. You should 
            plan on having about 20 gigabyte of free space per supported release and architecture.
            </p>
                    <p>
            By default, <span class="application"><strong>apt-mirror</strong></span> uses the configuration file in <code class="filename">/etc/apt/mirror.list</code>. 
            As it is set up, it will replicate only the architecture of the local machine. If you would like to support other 
            architectures on your mirror, simply duplicate the lines starting with “deb”, replacing the deb keyword by /deb-{arch}
            where arch can be i386, amd64, etc... For example, on an amd64 machine, to have the i386 archives as well, you will have:
            </p>
                    <pre class="programlisting">
deb  http://archive.ubuntu.com/ubuntu lucid main restricted universe multiverse 
/deb-i386  http://archive.ubuntu.com/ubuntu lucid main restricted universe multiverse

deb  http://archive.ubuntu.com/ubuntu lucid-updates main restricted universe multiverse 
/deb-i386  http://archive.ubuntu.com/ubuntu lucid-updates main restricted universe multiverse 

deb http://archive.ubuntu.com/ubuntu/ lucid-backports main restricted universe multiverse 
/deb-i386  http://archive.ubuntu.com/ubuntu lucid-backports main restricted universe multiverse 

deb http://security.ubuntu.com/ubuntu lucid-security main restricted universe multiverse 
/deb-i386  http://security.ubuntu.com/ubuntu lucid-security main restricted universe multiverse 

deb http://archive.ubuntu.com/ubuntu lucid main/debian-installer restricted/debian-installer universe/debian-installer multiverse/debian-installer 
/deb-i386 http://archive.ubuntu.com/ubuntu lucid main/debian-installer restricted/debian-installer universe/debian-installer multiverse/debian-installer 
</pre>
                    <p>
            Notice that the source packages are not mirrored as they are seldom used compared to the binaries and they do take
            a lot more space, but they can be easily added to the list.
            </p>
                    <p>
            Once the mirror has finished replicating (and this can be quite long), you need to configure Apache so that your
            mirror files (in <code class="filename">/var/spool/apt-mirror</code> if you did not change the default), are published by 
            your Apache server. For more information on Apache see <a class="xref" href="httpd.html" title="HTTPD - Apache2 Web Server">the section called “HTTPD - Apache2 Web Server”</a>.
            </p>
                  </div>
                </div>
                <div class="sect3" title="Installing in a RAM Disk">
                  <div class="titlepage">
                    <div>
                      <div>
                        <h4 class="title"><a id="jeos-ramdisk"></a>Installing in a RAM Disk</h4>
                      </div>
                    </div>
                  </div>
                  <p>
          As you can easily imagine, writing to RAM is a <span class="emphasis"><em>LOT</em></span> faster than writing to disk. If you have some 
          free memory, letting vmbuilder perform its operation in a RAMdisk will help a lot and the option <span class="emphasis"><em>--tmpfs</em></span>
          will help you do just that: 
          </p>
                  <pre class="programlisting">
--tmpfs OPTS  Use a tmpfs as the working directory, specifying its
              size or "-" to use tmpfs default (suid,dev,size=1G).
</pre>
                  <p>
          So adding <span class="command"><strong>--tmpfs -</strong></span> sounds like a very good idea if you have 1G of free ram. 
          </p>
                </div>
              </div>
              <div class="sect2" title="Package the Application">
                <div class="titlepage">
                  <div>
                    <div>
                      <h3 class="title"><a id="jeos-package-application"></a>Package the Application</h3>
                    </div>
                  </div>
                </div>
                <p>
        Two option are available to us:
        </p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" type="disc">
                    <li class="listitem">
                      <p>
            The recommended method to do so is to make a <span class="emphasis"><em>Debian</em></span> package. Since this is outside of the
            scope of this tutorial, we will not perform this here and invite the reader to read the documentation on how to do 
            this in the <a class="ulink" href="https://wiki.ubuntu.com/PackagingGuide" target="_top">Ubuntu Packaging Guide</a>. In this case it is 
            also a good idea to setup a repository for your package so that updates can be conveniently pulled from it. See the
            <a class="ulink" href="http://www.debian-administration.org/articles/286" target="_top">Debian Administration</a> article for a tutorial on this.
            </p>
                    </li>
                    <li class="listitem">
                      <p>
            Manually install the application under <code class="filename">/opt</code> as recommended by the 
            <a class="ulink" href="http://www.pathname.com/fhs/" target="_top">FHS guidelines</a>. 
            </p>
                    </li>
                  </ul>
                </div>
                <p>
        In our case we'll use <span class="application"><strong>Limesurvey</strong></span> as example web application for which we wish to provide 
        a virtual appliance. As noted before, we've made a version of the package available in a PPA (Personal Package Archive).
        </p>
              </div>
              <div class="sect2" title="Finishing Install">
                <div class="titlepage">
                  <div>
                    <div>
                      <h3 class="title"><a id="jeos-finish-install"></a>Finishing Install</h3>
                    </div>
                  </div>
                </div>
                <div class="sect3" title="First Boot">
                  <div class="titlepage">
                    <div>
                      <div>
                        <h4 class="title"><a id="jeos-first-boot"></a>First Boot</h4>
                      </div>
                    </div>
                  </div>
                  <p>
          As we mentioned earlier, the first time the machine boots we'll need to install <span class="application"><strong>openssh-server</strong></span>
          so that the key generated for it is unique for each machine. To do this, we'll write a script called <code class="filename">boot.sh</code>
          as follows: 
          </p>
                  <pre class="programlisting">
# This script will run the first time the virtual machine boots
# It is ran as root.

apt-get update
apt-get install -qqy --force-yes openssh-server
</pre>
                  <p>
          And we add the <span class="command"><strong>--firstboot boot.sh</strong></span> option to our command line.
          </p>
                </div>
                <div class="sect3" title="First Login">
                  <div class="titlepage">
                    <div>
                      <div>
                        <h4 class="title"><a id="jeos-first-login"></a>First Login</h4>
                      </div>
                    </div>
                  </div>
                  <p>
          Mysql and Limesurvey needing some user interaction during their setup, we'll set them up the first time a user 
          logs in using a script named login.sh. We'll also use this script to let the user specify: 
          </p>
                  <div class="itemizedlist">
                    <ul class="itemizedlist" type="disc">
                      <li class="listitem">
                        <p>His own password</p>
                      </li>
                      <li class="listitem">
                        <p>Define the keyboard and other locale info he wants to use</p>
                      </li>
                    </ul>
                  </div>
                  <p>
          So we'll define <code class="filename">login.sh</code> as follows: 
          </p>
                  <pre class="programlisting">
# This script is ran the first time a user logs in

echo "Your appliance is about to be finished to be set up."
echo "In order to do it, we'll need to ask you a few questions,"
echo "starting by changing your user password."

passwd

#give the opportunity to change the keyboard
sudo dpkg-reconfigure console-setup

#configure the mysql server root password
sudo dpkg-reconfigure mysql-server-5.0

#install limesurvey
sudo apt-get install -qqy --force-yes limesurvey

echo "Your appliance is now configured.  To use it point your"
echo "browser to http://serverip/limesurvey/admin"
</pre>
                  <p>
          And we add the <span class="command"><strong>--firstlogin login.sh</strong></span> option to our command line.
          </p>
                </div>
              </div>
              <div class="sect2" title="Useful Additions">
                <div class="titlepage">
                  <div>
                    <div>
                      <h3 class="title"><a id="jeos-additions"></a>Useful Additions</h3>
                    </div>
                  </div>
                </div>
                <div class="sect3" title="Configuring Automatic Updates">
                  <div class="titlepage">
                    <div>
                      <div>
                        <h4 class="title"><a id="jeos-automatic-updates"></a>Configuring Automatic Updates</h4>
                      </div>
                    </div>
                  </div>
                  <p>
        To have your system be configured to update itself on a regular basis, we will just install 
        <span class="application"><strong>unattended-upgrades</strong></span>, so we add the following option to our command line:
        </p>
                  <pre class="screen">
<span class="command"><strong>--addpkg unattended-upgrades</strong></span>
</pre>
                  <p>
      As we have put our application package in a PPA, the process will update not only the system, but also 
      the application each time we update the version in the PPA.
      </p>
                </div>
                <div class="sect3" title="ACPI Event Handling">
                  <div class="titlepage">
                    <div>
                      <div>
                        <h4 class="title"><a id="jeos-acpi"></a>ACPI Event Handling</h4>
                      </div>
                    </div>
                  </div>
                  <p>
        For your virtual machine to be able to handle restart and shutdown events it is being sent, it is a good idea to install the acpid package as
        well. To do this we just add the following option: 
        </p>
                  <pre class="screen">
<span class="command"><strong>--addpkg acpid</strong></span>
</pre>
                </div>
              </div>
              <div class="sect2" title="Final Command">
                <div class="titlepage">
                  <div>
                    <div>
                      <h3 class="title"><a id="jeos-final-command"></a>Final Command</h3>
                    </div>
                  </div>
                </div>
                <p>
      Here is the command with all the options discussed above:      
      </p>
                <pre class="screen">
<span class="command"><strong>sudo vmbuilder kvm ubuntu --suite lucid --flavour virtual --arch i386 -o \ 
         --libvirt qemu:///system --ip 192.168.0.100 --part vmbuilder.partition --user user \
         --name user --pass default --addpkg apache2 --addpkg apache2-mpm-prefork \ 
         --addpkg apache2-utils --addpkg apache2.2-common --addpkg dbconfig-common \ 
         --addpkg libapache2-mod-php5 --addpkg mysql-client --addpkg php5-cli \ 
         --addpkg php5-gd --addpkg php5-ldap --addpkg php5-mysql --addpkg wwwconfig-common \
         --addpkg mysql-server --addpkg unattended-upgrades --addpkg acpid --ppa nijaba \ 
         --mirror http://mirroraddress:9999/ubuntu --tmpfs - --firstboot boot.sh \
         --firstlogin login.sh es
         </strong></span>
</pre>
              </div>
              <div class="sect2" title="Resources">
                <div class="titlepage">
                  <div>
                    <div>
                      <h3 class="title"><a id="jeos-resources"></a>Resources</h3>
                    </div>
                  </div>
                </div>
                <p>
      If you are interested in learning more, have questions or suggestions, please contact the Ubuntu Server Team at:
      </p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" type="disc">
                    <li class="listitem">
                      <p>
          IRC: #ubuntu-server on freenode
          </p>
                    </li>
                    <li class="listitem">
                      <p>
          Mailing list: <a class="ulink" href="https://lists.ubuntu.com/mailman/listinfo/ubuntu-server" target="_top">ubuntu-server at lists.ubuntu.com</a>
          </p>
                    </li>
                    <li class="listitem">
                      <p>
          Also, see the <a class="ulink" href="https://help.ubuntu.com/community/JeOSVMBuilder" target="_top">JeOSVMBuilder Ubuntu Wiki</a> page.
          </p>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
          <div xmlns="http://www.w3.org/1999/xhtml" class="navfooter">
            <hr />
            <table width="100%" summary="Navigation footer">
              <tr>
                <td width="40%" align="left"><a accesskey="p" href="libvirt.html"><img src="../../libs/navig/prev.png" alt="Prev" /></a> </td>
                <td width="20%" align="center">
                  <a accesskey="u" href="virtualization.html">
                    <img src="../../libs/navig/up.png" alt="Up" />
                  </a>
                </td>
                <td width="40%" align="right"> <a accesskey="n" href="uec.html"><img src="../../libs/navig/next.png" alt="Next" /></a></td>
              </tr>
              <tr>
                <td width="40%" align="left" valign="top">libvirt </td>
                <td width="20%" align="center">
                  <a accesskey="h" href="index.html">
                    <img src="../../libs/navig/home.png" alt="Home" />
                  </a>
                </td>
                <td width="40%" align="right" valign="top"> UEC</td>
              </tr>
            </table>
          </div>
          <hr />
          <div id="footer">
            <div id="ubuntulinks">
              <p>The material in this document is available under a free license, see <a href="/legal.html">Legal</a> for details<br />
	For information on contributing see the <a href="https://wiki.ubuntu.com/DocumentationTeam">Ubuntu Documentation Team wiki page</a>. To report a problem, visit the <a href="https://bugs.launchpad.net/ubuntu/+source/ubuntu-docs">bug page for Ubuntu Documentation</a></p>
            </div>
          </div>
          <div id="bottomcap">
            <img src="https://help.ubuntu.com/htdocs/ubuntunew/img/cap-bottom.png" alt="" />
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
